<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>1mobile</title>
	<link rel="stylesheet" media="all" href="data/css/all.css">
	<link rel="stylesheet" media="all" href="data/css/media.css">
	<script src="data/js/jquery-1.8.2.min.js"></script>
	<script src="data/js/handlebars.js"></script>
	<script src="data/js/date.format.js"></script>
	<script src="data/js/common.js"></script>
	<script src="data/content/json/races.js"></script>
	<!--[if lt IE 9]>
		<script src="data/js/html5.js"></script>
		<script src="data/js/respond.min.js"></script>
	<![endif]-->
</head>
<body>

<div class="p-wrap">
	<div class="p-head">
		<nav class="b-nav">
			<a href="#" class="b-nav__pin">Races</a>
			<a href="#" class="b-nav__pin">Championship</a>
			<a href="#" class="b-nav__pin">Activity</a>
		</nav>
	</div>
	<div class="p-tape">
		<div class="p-races js-content">
			<script type="text/x-handlebars-template" class="js-tpl-race">
				{{#races}}
				<div class="b-race b-race_off b-clear js-race">
					<a href="#{{race_id}}" class="b-race__link">
						<img src="data/content/pic/flag/{{race_alias}}.png" alt="{{race_name}}" class="b-race__pic">
						<strong class="b-race__title">{{race_name}}</strong>
					</a>
					<div class="b-race__dates js-race-date js-date" data-date="{{race_timetable.race}}">{{formatted_date race_timetable.race}}</div>
					<div class="b-race__countdown js-race-at">
						<span class="b-race__countdown__item"><span class="b-race__countdown__num js-race-at-days">9</span>days</span>
						<span class="b-race__countdown__item"><span class="b-race__countdown__num js-race-at-hours">15</span>hrs</span>
						<span class="b-race__countdown__item"><span class="b-race__countdown__num js-race-at-mins">35</span>min</span>
						<span class="b-race__countdown__item"><span class="b-race__countdown__num js-race-at-secs">35</span>sec</span>
					</div>
				</div>
				{{/races}}
			</script>
		</div>
	</div>
	<div class="p-foot">
		&copy;&nbsp;2012
	</div>
</div>

<script>
function drawRaces() {
	Handlebars.registerHelper('formatted_date', function(isoDate) {
		var date = new Date(isoDate);
		return date.format('dd mmmm, HH:MM');
	});

	var raceTemplate = $('.js-tpl-race').html(),
		raceTemplateComp = Handlebars.compile(raceTemplate),
		raceOut = raceTemplateComp(racesData),
		$racesBox = $('.js-content').html(raceOut),
		$raceItem = $('.js-race', $racesBox),
		$raceItemFirst = $('.js-race:first', $racesBox),
		$raceAt = $('.js-race-at', $raceItemFirst),
		$raceAtDays = $('.js-race-at-days', $raceAt),
		$raceAtHours = $('.js-race-at-hours', $raceAt),
		$raceAtMins = $('.js-race-at-mins', $raceAt),
		$raceAtSecs = $('.js-race-at-secs', $raceAt);

	$raceItemFirst.removeClass('b-race_off');
	countdown(isoDate, $raceAt);

}

function countdown(isoDate, box) {
	var isoDate = isoDate,
		end = new Date(isoDate),
		now = new Date(),
		timeDiff = end.getTime() - now.getTime();

	if (timeDiff <= 0) {
		clearTimeout(timer);
		return false;
		// Run any code needed for countdown completion here
	}

	var seconds = Math.floor(timeDiff / 1000),
		minutes = Math.floor(seconds / 60),
		hours = Math.floor(minutes / 60),
		days = Math.floor(hours / 24);

	hours %= 24;
	minutes %= 60;
	seconds %= 60;

	$('.js-race-at-days', box).text(days);
	$('.js-race-at-hours', box).text(hours);
	$('.js-race-at-mins', box).text(minutes);
	$('.js-race-at-secs', box).text(seconds);

	var timer = setTimeout(function(){
		countdown(isoDate, box);
	}, 1000);
}


$(function(){
	drawRaces();
	//countdown();
});



</script>

</body>
</html>
